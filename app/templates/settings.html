{% extends "base.html" %}

{% block title %}Settings - AIOps Test Manager{% endblock %}

{% block content %}
<div x-data="settingsData()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h2>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Configure your AIOps test management system</p>
    </div>

    <!-- Settings Sections -->
    <div class="space-y-6">
        <!-- Target System Configuration -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Target System Configuration</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Configure the AIOps system or remote server where tests will be executed
            </p>

            <form @submit.prevent="saveSettings()" class="space-y-4">
                <!-- AIOps System URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        AIOps System URL *
                    </label>
                    <input
                        type="url"
                        x-model="settings.aiops_url"
                        required
                        placeholder="https://aiops.example.com"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Base URL of the AIOps system (local or remote)</p>
                </div>

                <!-- API Token -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        API Token / Authentication Key
                    </label>
                    <input
                        type="password"
                        x-model="settings.api_token"
                        placeholder="Optional API token for authentication"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">If your AIOps system requires authentication</p>
                </div>

                <!-- SSH Configuration (for remote systems) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            SSH Host (for remote execution)
                        </label>
                        <input
                            type="text"
                            x-model="settings.ssh_host"
                            placeholder="user@hostname or IP"
                            class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            SSH Port
                        </label>
                        <input
                            type="number"
                            x-model="settings.ssh_port"
                            placeholder="22"
                            min="1"
                            max="65535"
                            class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        >
                    </div>
                </div>

                <!-- Test Execution Path -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Test Execution Path
                    </label>
                    <input
                        type="text"
                        x-model="settings.test_path"
                        placeholder="/path/to/tests"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Path where test files are located on the target system</p>
                </div>

                <!-- Connection Timeout -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Connection Timeout (seconds)
                    </label>
                    <input
                        type="number"
                        x-model="settings.timeout"
                        placeholder="30"
                        min="5"
                        max="300"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                </div>

                <!-- Success/Error Messages -->
                <div x-show="saveSuccess" class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md">
                    <p class="text-sm text-green-800 dark:text-green-200">Settings saved successfully!</p>
                </div>

                <div x-show="saveError" class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
                    <p class="text-sm text-red-800 dark:text-red-200" x-text="saveError"></p>
                </div>

                <!-- Buttons -->
                <div class="flex justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button
                        type="button"
                        @click="testConnection()"
                        :disabled="testing"
                        class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 disabled:opacity-50"
                    >
                        <span x-show="!testing">Test Connection</span>
                        <span x-show="testing">Testing...</span>
                    </button>
                    <button
                        type="submit"
                        :disabled="saving"
                        class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-sm font-medium rounded-md hover:from-blue-600 hover:to-purple-700 disabled:opacity-50"
                    >
                        <span x-show="!saving">Save Settings</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Test Execution Settings -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Test Execution Settings</h3>

            <div class="space-y-4">
                <!-- Parallel Execution -->
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Enable Parallel Test Execution</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Run multiple tests simultaneously</p>
                    </div>
                    <input
                        type="checkbox"
                        x-model="settings.parallel_execution"
                        class="rounded border-gray-300 dark:border-gray-600 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                </div>

                <!-- Max Parallel Tests -->
                <div x-show="settings.parallel_execution">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Max Parallel Tests
                    </label>
                    <input
                        type="number"
                        x-model="settings.max_parallel"
                        placeholder="5"
                        min="1"
                        max="20"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                </div>

                <!-- Retry Failed Tests -->
                <div class="flex items-center justify-between">
                    <div>
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Auto-Retry Failed Tests</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Automatically retry failed tests</p>
                    </div>
                    <input
                        type="checkbox"
                        x-model="settings.retry_failed"
                        class="rounded border-gray-300 dark:border-gray-600 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                </div>

                <!-- Retry Count -->
                <div x-show="settings.retry_failed">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Retry Count
                    </label>
                    <input
                        type="number"
                        x-model="settings.retry_count"
                        placeholder="3"
                        min="1"
                        max="5"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    >
                </div>
            </div>
        </div>

        <!-- Current Configuration Info -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <h4 class="text-sm font-medium text-blue-900 dark:text-blue-200 mb-2">Current Configuration</h4>
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                <div>
                    <dt class="text-blue-700 dark:text-blue-300">Target URL:</dt>
                    <dd class="text-blue-900 dark:text-blue-100 font-mono" x-text="settings.aiops_url || 'Not configured'"></dd>
                </div>
                <div>
                    <dt class="text-blue-700 dark:text-blue-300">SSH Host:</dt>
                    <dd class="text-blue-900 dark:text-blue-100 font-mono" x-text="settings.ssh_host || 'Not configured'"></dd>
                </div>
                <div>
                    <dt class="text-blue-700 dark:text-blue-300">Test Path:</dt>
                    <dd class="text-blue-900 dark:text-blue-100 font-mono" x-text="settings.test_path || 'Not configured'"></dd>
                </div>
                <div>
                    <dt class="text-blue-700 dark:text-blue-300">Parallel Execution:</dt>
                    <dd class="text-blue-900 dark:text-blue-100" x-text="settings.parallel_execution ? 'Enabled' : 'Disabled'"></dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<script>
function settingsData() {
    return {
        settings: {
            aiops_url: '',
            api_token: '',
            ssh_host: '',
            ssh_port: 22,
            test_path: '',
            timeout: 30,
            parallel_execution: false,
            max_parallel: 5,
            retry_failed: false,
            retry_count: 3
        },
        saving: false,
        testing: false,
        saveSuccess: false,
        saveError: '',

        async init() {
            await this.loadSettings();
        },

        async loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    const data = await response.json();
                    this.settings = { ...this.settings, ...data };
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        },

        async saveSettings() {
            this.saving = true;
            this.saveSuccess = false;
            this.saveError = '';

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.settings)
                });

                if (response.ok) {
                    this.saveSuccess = true;
                    setTimeout(() => { this.saveSuccess = false; }, 3000);
                } else {
                    const error = await response.json();
                    this.saveError = error.detail || 'Failed to save settings';
                }
            } catch (error) {
                this.saveError = 'Failed to save settings: ' + error.message;
            } finally {
                this.saving = false;
            }
        },

        async testConnection() {
            this.testing = true;
            this.saveError = '';

            try {
                const response = await fetch('/api/settings/test-connection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: this.settings.aiops_url,
                        token: this.settings.api_token
                    })
                });

                if (response.ok) {
                    alert('Connection test successful!');
                } else {
                    const error = await response.json();
                    alert('Connection test failed: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Connection test failed: ' + error.message);
            } finally {
                this.testing = false;
            }
        }
    }
}
</script>
{% endblock %}
